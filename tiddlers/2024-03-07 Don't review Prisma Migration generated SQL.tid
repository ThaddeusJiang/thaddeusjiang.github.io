created: 20240307103154726
modified: 20240307110429659
published: 20240307110245684
tags: blog $:/plugins/adithyab/tiddlyjam/live
title: 2024-03-07 Don't review Prisma Migration generated SQL
type: text/vnd.tiddlywiki

å› ä¸ºå¤§é‡ç†Ÿç»ƒä½¿ç”¨ database toolsï¼Œå¦‚ï¼šPrisma å’Œ Ectoï¼Œæˆ‘å·²ç»ä¸èƒ½ç†Ÿç»ƒå†™å‡ºç›¸å¯¹å¤æ‚ SQL äº†ã€‚ğŸ˜­

ç›®å‰ï¼Œæˆ‘åœ¨è®¾è®¡å’Œå¼€å‘ä¸€ä¸ªèƒ½æºå›æ”¶å’Œè°ƒåº¦ç³»ç»Ÿï¼Œå› ä¸ºæˆ‘æ˜¯ä¸€ä¸ªä»¥â€œæ‡’â€ä½œä¸ºç¾å¾·çš„ç¨‹åºå‘˜ï¼Œæˆ‘æƒ³ç›´æ¥ä½¿ç”¨ Supabase æä¾›çš„ Auth æœåŠ¡ã€‚

ä½†æ˜¯æˆ‘å‘ç°åœ¨ Prisma schema ä¸­å®ç°çš„ many-to-many å…³ç³»ï¼Œæ— æ³•ä¼˜é›…åœ°ä½¿ç”¨ supabase-js æŸ¥è¯¢ã€‚

äºæ˜¯æˆ‘ç ”ç©¶äº†ä¸€ä¸‹åŸå› ï¼Œä¸çœ‹ä¸çŸ¥é“ï¼Œä¸€çœ‹å“ä¸€è·³ã€‚Prisma Migration ç”Ÿæˆçš„ many-to-many SQL å¥½å¤æ‚ï¼Œå®Œå…¨è¿åç›´è§‰ï¼Œåæ­£æˆ‘ review å›°éš¾ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ª role:permission many-to-many çš„ä¾‹å­ï¼š

```sql
// prisma.schema
model Permission {
  id    Int    @id @default(autoincrement())
  roles Role[]
}

model Role {
  id          Int          @id @default(autoincrement())
  permissions Permission[]
}
```

The SQL was generated by Prisma Migration:

```sql
-- CreateTable
CREATE TABLE "_PermissionToRole" (
    "A" INTEGER NOT NULL,
    "B" INTEGER NOT NULL
);

-- CreateIndex
CREATE UNIQUE INDEX "_PermissionToRole_AB_unique" ON "_PermissionToRole"("A", "B");

-- CreateIndex
CREATE INDEX "_PermissionToRole_B_index" ON "_PermissionToRole"("B");

-- AddForeignKey
ALTER TABLE "_PermissionToRole" ADD CONSTRAINT "_PermissionToRole_A_fkey" FOREIGN KEY ("A") REFERENCES "Permission"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "_PermissionToRole" ADD CONSTRAINT "_PermissionToRole_B_fkey" FOREIGN KEY ("B") REFERENCES "Role"("id") ON DELETE CASCADE ON UPDATE CASCADE;
```

ä¸Šé¢ SQL çœ‹çš„æˆ‘ä¸€æ„£ä¸€æ„£çš„ã€‚è€Œä¸”ä¸Šé¢ SQL ç”Ÿæˆçš„å…³ç³»åœ¨ supabase-js æŸ¥è¯¢è¯­å¥å¾ˆä¸‘ã€‚


```js
const { data, error } = await supabase.from("Role").select(`*, _PermissionToRole(
  A: Permission (*)
)`);
```


äºæ˜¯æˆ‘å‡­ç€è®°å¿†æ‰‹å†™äº†ä¸‹é¢è¿™æ®µ SQLã€‚

```sql
create table role (
  "id" serial primary key,
);

create table permission (
  "id" serial primary key,
);

create table members (
  "role_id" int references role,
  "permission_id" int references permission,
  primary key (role_id, permission_id)
);
```

ç»è¿‡æµ‹è¯•ï¼Œæˆ‘æ‰‹å†™çš„ SQL å¯ä»¥ä½¿ç”¨ supabase-js è¿›è¡Œå…³è”æŸ¥è¯¢ï¼Œä»£ç å¦‚ä¸‹ï¼š

```diff
- const { data, error } = await supabase.from("Role").select(`*, _PermissionToRole(
-   A: Permission (*)
- )`);

+ const {data, error} = await supabase.from("role").select("*, permission(*)")
```

!! é‚£ä¹ˆï¼Œä»Šåæˆ‘ä¼šæ‰‹å†™ SQL ç®¡ç† migrations å—ï¼Ÿ

ç­”ï¼šä¸ä¼šï¼Œå¦‚æœæ˜¯å›¢é˜Ÿåˆä½œçš„ JS é¡¹ç›®ï¼Œæˆ‘ä¾ç„¶ä¼šä½¿ç”¨ Prisma Migrationï¼Œå› ä¸ºå¤æ‚çš„å…³ç³»å’Œé™åˆ¶æ‰‹å†™ SQL æˆæœ¬å¤ªé«˜äº†ã€‚å·¥ä½œé‡ã€æ˜“å‡ºé”™ã€ç¼ºå°‘æ£€æŸ¥å·¥å…·ã€‚

æ‰€ä»¥ï¼Œç”±äºç§ç§åŸå› ï¼Œæˆ‘çš„ç»“è®ºï¼š

<<<.tc-big-quote
Don't review Prisma Migration generated SQL, focus on prisam.schema.
<<<TJ 2024-03-07

!! å¦‚æœæ˜¯éå›¢é˜Ÿé¡¹ç›® or é JS é¡¹ç›®

æˆ‘ä¼šä½¿ç”¨ Ecto ç®¡ç† migrationsã€‚

Ecto ç”Ÿæˆçš„ many-to-many SQL ç®€æ´åˆå‡†ç¡®

```elixir
create table(:role_permission, primary_key: false) do
  add :role_id, references(:role), primary_key: true
  add :permission_id, references(:permission), primary_key: true
end
```

```sql
-- Table Definition
CREATE TABLE "public"."role_permission" (
    "role_id" int8 NOT NULL,
    "permission_id" int8 NOT NULL,
    CONSTRAINT "role_permission_role_id_fkey" FOREIGN KEY ("role_id") REFERENCES "public"."role"("id"),
    CONSTRAINT "role_permission_permission_id_fkey" FOREIGN KEY ("permission_id") REFERENCES "public"."permission"("id"),
    PRIMARY KEY ("role_id","permission_id")
);
```

å¯¹æ¯” Prsima ç”Ÿæˆçš„ SQLï¼Œé«˜ä¸‹ç«‹åˆ¤ã€‚
