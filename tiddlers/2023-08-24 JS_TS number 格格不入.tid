created: 20230824124743786
modified: 20231004115730172
published: 20230824134406933
tags: blog $:/plugins/adithyab/tiddlyjam/live work
title: 2023-08-24 JS/TS number æ ¼æ ¼ä¸å…¥
type: text/vnd.tiddlywiki

imo: TypeScript number ç±»å‹å®šä¹‰æ¨¡ç³Šï¼ŒJavaScript number ç²¾åº¦éä¸»æµï¼ŒECMAScript bigint é™åˆ¶è¶…å¤šã€‚JS/TS number ä¸å…¶ä»–ç¼–ç¨‹è¯­è¨€æ˜¾å¾—æ ¼æ ¼ä¸å…¥ã€‚

ä¸è¦å¦„æƒ³ TypeScript å¯ä»¥æ‹¯æ•‘ JavaScript numberï¼ŒTypeScript çš„ number ç±»å‹å› ä¸ºéœ€è¦å…¼å®¹ JavaScriptï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰ int32 int64 ç­‰ç»†åˆ†ç±»å‹ï¼Œæ•°å€¼çš„ç²¾åº¦èŒƒå›´ä¹Ÿç»§æ‰¿äº† JavaScript åŸ‹çš„å‘ã€‚ğŸ¤·

åˆ†äº«å‡ ä¸ªæˆ‘é‡åˆ°çš„é—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆï¼š

!!! 1. JS/TS number å…¨èº«éƒ½æ˜¯ bug

JS/TS number å› ä¸ºè¦åŒæ—¶å…¼å®¹ int float double å¯¼è‡´å®ƒçš„ç²¾åº¦å¾ˆè¿·ï¼Œä¸å¼ºç±»å‹å·¥å…·ï¼ˆå¦‚ RDB, protobufï¼‰çš„æ•°å€¼èŒƒå›´ä¸Šæœ‰å·®å¼‚ï¼Œéå¸¸å®¹æ˜“äº§ç”Ÿ bugã€‚

JS æœ€å¤§å®‰å…¨æ•´æ•°ï¼ˆèƒ½å¤Ÿç²¾ç¡®è¡¨ç¤ºçš„æ•´æ•°ï¼‰ä¸º 9,007,199,254,740,991ï¼ˆ2^^53^^ - 1ï¼‰ï¼Œè¿œå°äº int64 (2^^63^^ - 1)ã€‚æ‰€ä»¥å¦‚æœä½ åœ¨ RDB ä¸­ä½¿ç”¨ int64 ç±»å‹ï¼Œåœ¨ JS ä¸­å°±ä¼šæº¢å‡ºã€‚

Example: 2^^64^^-1 is 1844674407370955''1615'' but in JavaScript it evaluates to 1844674407370955''2000''.

> ä½¿ç”¨ long.js å¯ä»¥å¼¥è¡¥è¿™ä¸ªè®¾è®¡ç¼ºé™·ã€‚

ä½†æ˜¯ long.js ä¹Ÿæœ‰é—®é¢˜ï¼Œä¸ªäººå»ºè®®èƒ½ä¸ç”¨å°±åˆ«ç”¨ã€‚

!!! 2. JS/TS bigint é™åˆ¶è¶…å¤š

bigint è™½ç„¶æ˜¯æ•´æ•°ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ä¸Šæœ‰å¾ˆå¤šé™åˆ¶ï¼Œä¾‹å¦‚ï¼š

# BigInt ä¸ Number è½¬æ¢ä¼šæŸå¤±ç²¾åº¦
# BigInt åœ¨ JSON.stringify() ä¼šå¼•å‘ TypeError
# BigInt ä¸èƒ½ä½¿ç”¨ Math ä¸­æ–¹æ³•

å¤©å‘ğŸ¤·ï¼Œè¿™ä¹ˆå¤šé™åˆ¶ï¼Œè¿˜ä¸å®¹ä¸ç”¨å‘¢ã€‚åæ­£æˆ‘ä»æ¥ä¸ç”¨ bigintã€‚

å¦‚æœçœŸçš„éœ€è¦å¤„ç†è¶…å¤§æ•°å€¼ï¼Œæˆ‘æ¨èä½¿ç”¨ bignumber.jsï¼Œæˆ‘å¯ä¸æƒ³è‡ªå·±å†™æ•°å€¼è¿ç®—ï¼Œbignumber.js æä¾›äº†å¾ˆå¤šå¼€ç®±å³ç”¨çš„æ–¹æ³•ï¼š

<<img "https://raw.githubusercontent.com/MikeMcl/bignumber.js/gh-pages/API.png" "bignumber.js" >>


!! 3. int32 int64 å¯¹åº” TS ç±»å‹æ²¡æœ‰ç»Ÿä¸€æ ‡å‡†

Prisma scheme æ”¯æŒ BigInt ç±»å‹ï¼Œå¯¹åº” TS BigInt ç±»å‹

Protocol Buffers çš„ int32 int64 ç±»å‹åˆ†åˆ«å¯¹åº” TS number å’Œ Long

å¦‚æœä½ åŒæ—¶ä½¿ç”¨ Prisma BigInt å’Œ protobuf int64 çš„è¯ï¼Œä½ å¸¦ä»£ç ä¸­å°±ä¼šå‡ºç°å¤§é‡ç›¸äº’è½¬æ¢çš„ utilsï¼Œç±»ä¼¼ä¸‹é¢è¿™ç§ï¼š

> ğŸ‘‡è¿™äº›ä»£ç éƒ½æ˜¯æˆ‘ä»å…¶ä»–äººçš„ä»£ç ä¸­ copy è¿‡æ¥çš„ï¼Œä¸æ˜¯æˆ‘å†™çš„ï¼Œæˆ‘ä¹Ÿæ°¸è¿œä¸ç”¨å†™è¿™ç§ä»£ç ã€‚

```ts
export class BigIntUtil {
  static toNumber(b: bigint): number {
    const n = parseInt(b.toString());
    if (!Number.isSafeInteger(n)) {
      throw new Error(
        'Fail to cast bigint to number. Value is out of safe integer range.',
      );
    }
    return n;
  }

  static from(v: string | number | bigint): bigint {
    if (typeof v === 'bigint') {
      return v;
    }
    return BigInt(v);
  }
}
```

```ts
import Long from 'long';

export class LongUtil {
  public static fromBigInt(num: bigint): Long;
  public static fromBigInt(num: bigint | undefined | null): Long | undefined;
  public static fromBigInt(num: bigint | undefined | null): Long | undefined {
    if (num === undefined || num === null) {
      return undefined;
    }
    return Long.fromNumber(Number(num));
  }

  public static toBigInt(num: Long): bigint;
  public static toBigInt(num: Long | undefined | null): bigint | undefined;
  public static toBigInt(num: Long | undefined | null): bigint | undefined {
    if (num === undefined || num === null) {
      return undefined;
    }
    return BigInt(num.toNumber());
  }
}
```

```ts
export class JsonUtil {
  public static stringify(data: Record<string, any>): string {
    return JSON.stringify(data, (k, v) => {
      if (typeof v === 'bigint') {
        return v.toString();
      }
      return v;
    });
  }
}
```

ä½ æœ‰å…³äº JS/TS number çš„æ•…äº‹å—ï¼Ÿæ¬¢è¿ä¸æˆ‘åˆ†äº«ã€‚

refs:

* [[long.js|https://www.npmjs.com/package/long]]
* [[bignumber.js|https://www.npmjs.com/package/bignumber.js]]
* [[Prisma BigInt|https://www.prisma.io/docs/concepts/components/prisma-client/working-with-fields#working-with-bigint]]
* [[protobuf int64|https://protobuf.dev/programming-guides/proto3/]]
