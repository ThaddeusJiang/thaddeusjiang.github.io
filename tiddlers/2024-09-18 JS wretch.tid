created: 20240918064327295
modified: 20240918074532446
published: 20240918074532444
tags: blog $:/plugins/adithyab/tiddlyjam/live
title: 2024-09-18 JS wretch
type: text/vnd.tiddlywiki

å…³äº JS HTTP request client libraryï¼Œç°é˜¶æ®µæˆ‘æ¨è wretchã€‚

> æˆ‘çš„æŠ€æœ¯æ ˆå˜åŒ–ï¼šwretch <- fetch <- node-fetch <- axios

!! æˆ‘æ¨è wretch çš„ç†ç”±ï¼š

# é€‚å½“çš„å°è£…ï¼Œä¸éœ€è¦ç¼–å†™å¤§é‡ä¸šåŠ¡æ— å…³çš„ boilerplate code
# ç»Ÿä¸€å®ç°çš„è¯·æ±‚æ ¼å¼ï¼Œå¦‚ï¼šè¯·æ±‚ application/json, multipart/form-data, application/x-www-form-urlencoded
# å¼€ç®±å³ç”¨çš„é«˜çº§åŠŸèƒ½ï¼Œå¦‚ï¼šretry, delay, abort ç­‰ç­‰

!! æŠ€æœ¯æ ˆå˜åŒ–ç®€è¿°

* axios: ES æå‡º fetch() API å‰ï¼Œåªè®°å¾— axiosï¼ŒXMLHttpRequest æˆ‘å·²ç»ä¸è®°å¾—äº†ã€‚
* node-fetch: ES æå‡º fetch() API åï¼Œä½†æ˜¯ Node.js æ²¡æœ‰å®ç°å‡ºæ¥
* fetch: Node.js 18 å‘å¸ƒ fetch() API å
* wretch: å†™ fetch() å¤ªç–²åŠ³äº†ï¼Œå¯»æ‰¾ç®€å•çš„å·¥å…·


!! 1. ä»€ä¹ˆæ˜¯â€œä¸éœ€è¦ç¼–å†™å¤§é‡ä¸šåŠ¡æ— å…³çš„ boilerplate codeâ€

fetch éœ€è¦æ‰‹åŠ¨é…ç½® http methods, headers and body

```is
fetch("endpoint", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ "hello": "world" })
}).then(response => /* ... */)
```

fetch() éœ€è¦æ‰‹åŠ¨å¤„ç† statusï¼Œå †å  if-else

```js
// ğŸ˜®â€ğŸ’¨
fetch("anything")
  .then(response => {
    if(!response.ok) {
      if(response.status === 404) throw new Error("Not found")
      else if(response.status === 401) throw new Error("Unauthorized")
      else if(response.status === 418) throw new Error("I'm a teapot !")
      else throw new Error("Other error")
    }
    else // ...
  })
  .then(data => /* ... */)
  .catch(error => { /* ... */ })
```

> è€Œè¿™äº›éƒ½æ˜¯ä¸šåŠ¡æ— å…³çš„ä»£ç ï¼Œä»…ä»…æ˜¯ä¸ºäº†é…åˆ fetch() API çš„ä½¿ç”¨ã€‚

wretch å°è£…äº†è¿™äº›ä¸šåŠ¡æ— å…³çš„ä»£ç ï¼Œè®©ä½ ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ã€‚

```js
wretch("endpoint")
  .post({ "hello": "world" })
  .notFound(error => { /* ... */ })
  .unauthorized(error => { /* ... */ })
  .error(418, error => { /* ... */ })
  .res(response => /* ... */)
  .catch(error => { /* uncaught errors */ })
```

!! 2. ä»€ä¹ˆæ˜¯â€œç»Ÿä¸€å®ç°çš„è¯·æ±‚æ ¼å¼â€

wretch æ— è®ºæ˜¯å‘é€ json æˆ– form-data äº¦æˆ– x-www-form-urlencoded éƒ½å¯ä»¥ç›´æ¥è°ƒç”¨ JS object å¯¹è±¡ã€‚

> So Sweet ğŸ¥°

```js
const form = { a: 1, b: { c: 2 } };

// ğŸ“¤ application/json
wretch("...").post(form)

// ğŸ“¤ multipart/form-data
import FormDataAddon from "wretch/addons/formData"
wretch("...").addon(FormDataAddon).formData(form).post();

// ğŸ“¤ application/x-www-form-urlencoded
import FormUrlAddon from "wretch/addons/formUrl"
wretch("...").addon(FormUrlAddon).formUrl(form).post();
```

fetch()

# å‘é€ json éœ€è¦ `JSON.stringify();`
# å‘é€ form-data éœ€è¦æ„å»º `new FormData();`
# å‘é€ x-www-form-urlencoded éœ€è¦ `new URLSearchParams();`

> Why? ğŸ˜µâ€ğŸ’«

```js
const data = { a: 1, b: { c: 2 } }

// ğŸ“¤ application/json
fetch("endpoint", {
  method: "POST",
  headers: { "Content-Type": "application/json" }, // 1ï¸âƒ£
  body: JSON.stringify(data) // 2ï¸âƒ£
}).then(response => /* ... */)

// ğŸ“¤ multipar/form-data
const formData = new FormData(); // 1ï¸âƒ£
formData.append('a', 1);
formData.append('b', JSON.stringify({ c: 2})); // 2ï¸âƒ£

fetch('https://example.com/submit', {
    method: 'POST',
    body: formData
}).then(response => /* ... */)

// ğŸ“¤ application/x-www-form-urlencoded
const data = new URLSearchParams(); // 1ï¸âƒ£
data.append('a', 1);
data.append('b', JSON.stringify({ c: 2})); // 2ï¸âƒ£

fetch('https://example.com/submit', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded' // 3ï¸âƒ£
    },
    body: data.toString()() // 4ï¸âƒ£
}).then(response => /* ... */)
```

!! 3. wretch æä¾›çš„â€œå¼€ç®±å³ç”¨çš„é«˜çº§åŠŸèƒ½â€

wretch å®ç° retry åŠŸèƒ½ So Easy

```js
import { retry } from "wretch/middlewares"

const w = wretch().middlewares([retry()])
```

fetch() å®ç° retry åŠŸèƒ½ï¼ŒSo Hard

```js
// generated by ChatGPT
function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
    return fetch(url, options)
        .then(response => {
            if (!response.ok) {
                if (retries > 0) {
                    console.log(`Retrying... ${retries} attempts left.`);
                    return new Promise((resolve) => {
                        setTimeout(() => resolve(fetchWithRetry(url, options, retries - 1, delay)), delay);
                    });
                } else {
                    throw new Error('Max retries reached, fetch failed.');
                }
            }
            return response.json(); // å¤„ç†è¿”å›çš„å“åº”ä½“ï¼ˆå‡è®¾æ˜¯ JSON æ ¼å¼ï¼‰
        })
        .catch(error => {
            if (retries > 0) {
                console.log(`Retrying due to error: ${error.message}, ${retries} attempts left.`);
                return new Promise((resolve) => {
                    setTimeout(() => resolve(fetchWithRetry(url, options, retries - 1, delay)), delay);
                });
            } else {
                throw new Error('Max retries reached, fetch failed: ' + error.message);
            }
        });
}

// è°ƒç”¨
fetchWithRetry('https://example.com/api', { method: 'GET' })
    .then(data => console.log('Success:', data))
    .catch(error => console.error('Error:', error));

```

æ›´ä¸ç”¨æ delay abort ç­‰é«˜çº§åŠŸèƒ½äº†ã€‚

!! æˆ‘å‘ç°çš„ wretch çš„ä¸€ç‚¹ç‚¹ä¸è¶³

# progress ç‰¹æ€§ä»…æ”¯æŒ download https://github.com/elbywan/wretch/issues/225#issuecomment-2105633417
# æ²¡æœ‰å¼€ç®±å³ç”¨ Stream handler

refs

* https://github.com/elbywan/wretch
* https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API
* https://github.com/node-fetch/node-fetch
* https://github.com/axios/axios
* https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest
