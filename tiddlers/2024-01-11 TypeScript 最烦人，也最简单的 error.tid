created: 20240110135743677
modified: 20250507023205957
published: 20240110194426095
tags: blog $:/plugins/adithyab/tiddlyjam/live
title: 2024-01-11 TypeScript æœ€çƒ¦äººï¼Œä¹Ÿæœ€ç®€å•çš„ error
type: text/vnd.tiddlywiki

! ã€ŠTypeScript optional çš„æ··ä¹±ç”Ÿæ€ã€‹

TypeScript æœ€çƒ¦äººçš„ä¹Ÿæœ€ç®€å•çš„é”™è¯¯å¯èƒ½å°±æ˜¯ optional å£°æ˜æ–¹å¼ä¸å…¼å®¹äº†å§ã€‚

ç›¸ä¿¡æ‰€æœ‰ TypeScript å¼€å‘è€…éƒ½é‡åˆ°ä¸‹é¢çš„é”™è¯¯æ—¥å¿—å§ï¼Ÿ

```ts
Type 'number | null' is not assignable to type 'number | undefined'.
  Type 'null' is not assignable to type 'number | undefined'.ts(2322)
```

è™½ç„¶è¿™ä¸ªé”™è¯¯çš„è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œä½†æ˜¯æ—¶ä¸æ—¶å°±è¢«å®ƒçƒ¦ä¸€ä¸‹ï¼Œä¹Ÿæ˜¯æœæ°”äº†ã€‚å¿ä¸ä½æƒ³åæ§½å‡ å¥ã€‚

<<<.tc-big-quote
TypeScript optional å£°æ˜æ–¹å¼ä¸å…¼å®¹é€ æˆäº†ç”Ÿæ€é—®é¢˜ï¼Œä¸æ˜¯ç®€å•çš„è¯­æ³•é—®é¢˜ã€‚
<<<TJ 2024-01-11

å¦‚æœåªæ˜¯ç®€å•çš„è¯­æ³•é—®é¢˜ï¼Œæˆ‘åˆä½•å¿…åæ§½å‘¢ï¼Ÿ

å¦‚æœåªæ˜¯ç®€å•çš„ç¨‹åºï¼Œæ²¡æœ‰ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œä¸æ¶‰åŠå·¥å…·é“¾ï¼Œé‚£å°±åšå¥½è‡ªå·±å°±è¡Œäº†ã€‚åªè¦è‡ªå·±å’Œå›¢é˜Ÿåšå¾—å¥½ï¼ŒTypeScript optional å£°æ˜æ–¹å¼ä¸å…¼å®¹çš„é—®é¢˜æ˜¯å¯ä»¥é¿å…çš„ã€‚

ä½†æ˜¯å¯¹äºå¤æ‚çš„ç¨‹åºï¼Œæœ‰å¤§é‡ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå¹¶ä½¿ç”¨å„ç§å·¥å…·é“¾è¾…åŠ©å¼€å‘ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯ç”Ÿæ€é—®é¢˜ã€‚åªé è‡ªå·±å’Œå›¢é˜Ÿé¿å‘æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œå› ä¸ºç”Ÿæ€é‡Œçš„æ€»æœ‰äººä¼šæŒ–å¥½å‘ç­‰ä½ ã€‚

!! ä¸ºä»€ä¹ˆè¯´æ˜¯ç”Ÿæ€é—®é¢˜å‘¢ï¼Ÿ

å…ˆè§£é‡Šä¸€ä¸‹æˆ‘ç°åœ¨å‚åŠ çš„é¡¹ç›®çš„æŠ€æœ¯æ ˆï¼š

# [[protobuf]] å®šä¹‰ gRPC request responseï¼Œå¹¶é€šè¿‡ codegen ç”Ÿæˆ gRPC server å’Œ client çš„ TypeScript ç±»å‹å®šä¹‰
# [[prisma]] å®šä¹‰ database schemaï¼Œå¹¶é€šè¿‡ prisma generate ç”Ÿæˆ TypeScript ç±»å‹å®šä¹‰
# [[class-validator]] å®šä¹‰ validation schema
# [[TypeScript]] ç¼–å†™ä¸šåŠ¡ä»£ç å’Œè¾…åŠ©æ•°æ®

é’ˆå¯¹æœ€å¼€å§‹åˆ†äº«çš„ TypeScript error æˆ‘åˆ†äº«ä¸€ä¸‹æˆ‘çš„ protobuf prisma class-validator TypeScript åˆ†åˆ«æ˜¯æ€ä¹ˆå†™çš„ï¼Œå¦‚æœä½ æ˜¯ TypeScript developerï¼Œç›¸ä¿¡ä½ ä¸€å®šèƒ½çœ‹æ‡‚ã€‚

!!! 1. protobuf and generated code

protobuf code

```ts
// .proto
message ChargingProfile {
  // ...
  optional int32 duration = 2;
  // ...
}
```

protobuf generated code 

```ts
// dist/buf/check_in_history_pb.ts
export class ChargingProfile extends Message<ChargingProfile> {
  // ...
  /**
   * @generated from field: optional int32 duration = 2;
   */
  duration?: number;
  // ...
```

!! 2. prisma and generated code

prisma schema

```ts
// schema.prisma
model ChargingProfile {
  // ...
  duration                Int?
  // ...
}
```

prisma schema generated code

```ts
// node_module/.prisma/client/index.d.ts
export type ChargingProfile = {
  // ...
  duration: number | null
  // ...
}
```

!!! å°ç»“

æ³¨æ„çœ‹ï¼Œprotobuf generated code å’Œ prisma schema generated code

```diff
  // protobuf generated code
+  duration?: number;
  //prisma schema generated code
+  duration: number | null
```

æœ€å¼€å§‹åˆ†äº«çš„ TypeScript error å°±æ˜¯å› ä¸ºè¿™ä¸ªåŸå› é€ æˆçš„ï¼Œæˆ‘åœ¨ x.com ä¸Šåˆ†äº«äº†è¿™æ®µä»£ç ï¼Œå¾ˆå¤šæœ‹å‹åˆ†äº«äº†ä»–ä»¬çš„é¿å…æ–¹æ³•ã€‚ä½†æ˜¯ `generated code` å®Œå…¨ä¸æ˜¯æˆ‘ç¼–å†™çš„ï¼Œè€Œæ˜¯ TypeScript ç”Ÿæ€ä¸­å·¥å…·é“¾ç”Ÿæˆçš„ï¼Œå³ä½¿æˆ‘çš„å®šä¹‰æ˜¯ç›¸åŒçš„ï¼Œä¸åŒå·¥å…·é“¾ç”Ÿæˆçš„ä»£ç è¿˜æ˜¯é€ æˆäº† TypeScripr errorï¼Œæˆ‘çœŸä¸çŸ¥é“æˆ‘è¦å¦‚ä½•é¿å…è¿™ä¸ªé”™è¯¯ã€‚ğŸ¤·

<<<.tc-big-quote
BTW è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ³•éå¸¸ç®€å•ï¼Œæˆ‘å¹¶ä¸æ˜¯ä¸èƒ½è§£å†³ã€‚
åªæ˜¯å®ƒç»å¸¸å‡ºæ¥çƒ¦æˆ‘ä¸€ä¸‹ï¼Œè®©æˆ‘å¿ä¸ä½æƒ³åæ§½ã€‚
<<<TJ 2024-01-11

!! 3. class-validator

```ts
export class ChargingProfileDto {
  // ...
  @IsOptional()
  @IsInt()
  duration?: number;
  // ...
}
```

å…¶å® class-validator å®ç°çš„ä»£ç å’Œæœ¬æ–‡æ²¡ä»€ä¹ˆå…³ç³»ï¼Œä¸è¿‡è¿™æ®µä»£ç æ˜¯çœŸå®å­˜åœ¨äºæˆ‘ä»¬çš„ä»£ç åº“ä¸­çš„ï¼Œæˆ‘å°±é¡ºä¾¿åˆ†äº«ä¸€ä¸‹ã€‚

å¹¶ä¸”ï¼Œæˆ‘éå¸¸ä¸å–œæ¬¢ class-validatorï¼ŒåŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

# class-validator å’Œ TypeScript åœ¨æŸäº›æ–¹é¢æ˜¯é‡å¤çš„ï¼Œä¾‹å¦‚ `@IsOptional()` å’Œ `?`
# class-validator åªèƒ½æ ¡éªŒ class instanceï¼Œå¦‚æœæƒ³æ ¡éªŒ JSON è¿˜éœ€è¦é¢å¤–ä¾èµ–ï¼ˆclass-transformerï¼‰
# class-validator æ–‡æ¡£ä¸å…¨ï¼Œä¾‹å¦‚ï¼šæˆ‘ä¸€ç›´æ²¡æœ‰æ‰¾åˆ° `@IsNumber(options: IsNumberOptions)` ä¸­ options æœ‰å“ªäº›é…ç½®é¡¹




!! æœ€åï¼Œåˆ†äº«å‡ ç§ TypeScript ä¸­ number çš„å®šä¹‰

```ts
type A = {
  a?: number
}

type B = {
  a: number | undefined
}

type C = {
  a: number | null
}

type D = {
  a: number | null | undefined
}

type E = {
  a: number = 0
}
```

å¤§å®¶å‚åŠ çš„é¡¹ç›®ä¸­ç”¨å“ªä¸€ç§å‘¢ï¼Ÿå°±ä¸ªäººè€Œè¨€ï¼Œä½ å€¾å‘å“ªä¸€ç§ï¼Ÿ

æ¬¢è¿å¤§å®¶å’Œæˆ‘ä¸€èµ·è®¨è®ºï¼š

* x.com: https://x.com/ThaddeusJiang/status/1745085873807347771
* telegram: https://t.me/talktalk_developer/539
* github: https://github.com/ThaddeusJiang/thaddeusjiang.github.io/discussions/63

!! æ›´æ–°

> 2025-05-07 

åœ¨ nuqs å†æ¬¡é‡åˆ° optional field default value is `null` çš„é—®é¢˜ã€‚

[img[https://i.gyazo.com/791446cf42b5a90ce5d4190c213e257f.png]]

åœ¨ nuqs ä¸­ï¼Œå¦‚æœåœ¨ query string ä¸­æ²¡æœ‰æ‰¾åˆ°æŒ‡å®š keyï¼Œè¿”å›çš„å€¼æ˜¯ `null`ã€‚


* https://nuqs.47ng.com/docs/basic-usage

refs

* https://protobuf.dev/
* https://www.prisma.io/
* https://www.typescriptlang.org/
* https://github.com/typestack/class-validator
* https://github.com/typestack/class-transformer


