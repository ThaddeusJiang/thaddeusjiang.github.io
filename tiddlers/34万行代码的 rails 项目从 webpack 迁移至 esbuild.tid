created: 20250530022123411
modified: 20250530062738100
tags: 
title: 34ä¸‡è¡Œä»£ç çš„ rails é¡¹ç›®ä» webpack è¿ç§»è‡³ esbuild
type: text/vnd.tiddlywiki


TODO: 

ç»è¿‡ 3weeks çš„ review å’Œ testï¼Œæˆ‘è´Ÿè´£çš„ webpack -> esbuild PR ç»ˆäºè¢«åˆå¹¶äº†ã€‚
æœ¬æ¬¡å‡çº§ä¿®æ”¹äº† 301 ä¸ªæ–‡ä»¶ï¼Œäº§ç”Ÿ +6,837 âˆ’9,726 å·®åˆ†ï¼Œå‰åè€—æ—¶1ä¸ªæœˆã€‚è¾¾åˆ°çš„æ•ˆæœå¼€å‘ç¯å¢ƒä¸‹ auto-rebuild æé€Ÿ 2.48å€ï¼Œé¡¹ç›®æ•´ä½“ production build æé€Ÿ 2.48å€ï¼Œfrontend èµ„æº production build æé€Ÿ 115.79å€ã€‚


! æˆ‘åšäº†ä»€ä¹ˆï¼Ÿ

# ä½¿ç”¨ jsbundling-rails + esbuild æ›¿æ¢ webpacker
# é…ç½® esbuild.config.js ä»¥åŠ Dockerfile, docker-compose.yml 
# å¦¥å rails ä¸­ç‹¬ç«‹çš„ Sass å’Œ frontend ä¸­çš„ Sass
# åè°ƒ rails compile å’Œ esbuild bundles
# é¡ºæ‰‹æ”¹å–„ä¸€ä¸‹å¼€å‘ä½“éªŒ

! ç®€å•è®°å½•

!! 1. ä½¿ç”¨ jsbundling-rails + esbuild æ›¿æ¢ webpacker

> Issues: jsbundling-rails å’Œ cssbundling-rails å‚»å‚»åˆ†ä¸æ¸…æ¥š

å› ä¸ºä¸ç†Ÿæ‚‰ rails å¯¹äº frontend çš„é›†æˆï¼Œæˆ‘æœ€å¼€å§‹ä»¥ä¸ºéœ€è¦åŒæ—¶å¯¼å…¥ jsbundling-rails å’Œ cssbundling-railsï¼Œä¸€ä¸ªåªè´Ÿè´£ js å¦å¤–ä¸€ä¸ªåªè´Ÿè´£ cssã€‚

ä½†åœ¨å®é™…é…ç½® jsbundling-rails + esbuild è¿‡ç¨‹ä¸­ï¼Œæˆ‘éšæ‰‹åœ¨ esbuild ä¸­é…ç½®äº† Sassï¼Œè€Œä¸”ä¼¼ä¹æ­£å¸¸å·¥ä½œäº†ã€‚å½“æ—¶æˆ‘æœ‰ä¸€ç‚¹å›°æƒ‘ ğŸ«£

æœ€åï¼Œæˆ‘æ²¡æœ‰ä½¿ç”¨ cssbundling-rails ã€‚è€Œæ˜¯ä½¿ç”¨ esbuild ç»Ÿä¸€å¤„ç†äº†æ‰€æœ‰ frontend èµ„æºï¼ˆjs + css + images + fontï¼‰ã€‚ 

ç®€å•åˆ†äº«ï¼šwebpack -> esbuild å‰å Gemfile diff

```diff
- gem 'webpacker'

+ gem 'jsbundling-rails'
+ gem 'esbuild-rails'
```

å¿ƒå¾—ï¼š

Modern frontend å…¶å®ä¸éœ€è¦ä¸¥æ ¼åŒºåˆ† JS, CSS, HTML, Image, Font ç­‰èµ„æºï¼Œåœ¨å¤§å¤šæ•°ç°ä»£åŒ–å·¥å…·ä¸­è¿™äº›èµ„æºéƒ½æ˜¯åŒæ„çš„ï¼Œå¯ä»¥ç»Ÿä¸€å¤„ç†ã€‚æˆ‘ä»¬ä½¿ç”¨ esbuild å¯¹ Sass è¿›è¡Œç¼–è¯‘åï¼Œå°±ä¸éœ€è¦å†ä¾èµ– cssbundling-rails äº†ã€‚

!! 2. é…ç½® esbuild

> Issues: ä¸æ˜¯åªæœ‰ SPA 

å¯èƒ½æ˜¯ frontend ç¤¾åŒºä¸­ SPA çš„æµè¡Œåº¦å¤ªé«˜ï¼Œesbuild å®˜æ–¹æ–‡æ¡£ä¸­ç«Ÿç„¶æ²¡æœ‰å…³äº MPA çš„é…ç½®ç¤ºä¾‹ã€‚

å¯æ˜¯æˆ‘ä»¬çš„ rails é¡¹ç›®å´æ˜¯ä¸€ä¸ªä¾èµ– rails routes çš„ multiple pages applicationï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®ä¸åŒé¡µé¢çš„ä¸åŒéœ€æ±‚ç¼–è¯‘å‡ºä¸åŒçš„ frontend applicationã€‚å¹¸å¥½ esbuild è™½ç„¶æ²¡æœ‰ç¤ºä¾‹ï¼Œå´å·²æ”¯æŒå¤šå…¥å£ã€‚

ç®€å•åˆ†äº«ï¼šå®é™…çš„ esbuild entryPoints

```js
// esbuild.config.js
const entryPoints = {
  'crm/mice/index': 'packs/crm/mice/index.js',
  'crm/index': 'packs/crm/index.js',
  'crm/channel_talk': 'packs/crm/channel_talk.js',
  'crm/anniversary/index': 'packs/crm/anniversary/index.js',
  'crm/dashBoards/index': 'packs/crm/dashBoards/index.js',
  'crm/salesContents/index': 'packs/crm/salesContents/index.js',
  'crm/setting/index': 'packs/crm/setting/index.js',
  'crm/marketing/index': 'packs/crm/marketing/index.js',
  'customer/sales_content': 'packs/customer/sales_content.js',
  'customer/survey_answer': 'packs/customer/survey_answer.js',
  crm: 'stylesheets/crm.scss',
  customer: 'stylesheets/customer.scss',
  application: 'stylesheets/application.scss',
}

const isDevelopment = process.env.NODE_ENV === 'development'

const context = await esbuild.context({
  entryPoints: Object.entries(entryPoints).map(([outPath, entry]) => ({
    in: path.join(__dirname, 'app/javascript', entry),
    out: outPath,
  })),
  ...
```

!! 3. å¦¥å rails ä¸­ç‹¬ç«‹çš„ Sass å’Œ frontend ä¸­çš„ Sass

> Issues: ç”±äºé¡¹ç›®ä¾èµ– ActiveAdmin æ‰€ä»¥æ— æ³•å®Œå…¨ç§»é™¤ sass-rails ï¼Œä¸å¾—ä¸å®ç° esbuild-rails å’Œ sass-rails å’Œè°å…±å¤„ã€‚

æ‰€ä»¥æœ¬é¡¹ç›®å…¶å®åœ¨ esbuild å’Œ rails compile ä¸­åˆ†åˆ«å¤„ç†äº† 2æ¬¡ Sass èµ„æºã€‚

å¹¶ä¸”åœ¨å¯»æ‰¾ esbuild plugins æ¥å‡å°‘è‡ªå®šä¹‰é…ç½®æ—¶ï¼Œæˆ‘å‘ç°ç¤¾åŒºä¸­æœ‰ä¸¤ä¸ªç›¸ä¼¼çš„æ’ä»¶ esbuild-sass-plugin å’Œ esbuild-plugin-sassã€‚å› ä¸ºåå­—å¤ªç±»ä¼¼äº†ï¼ŒæŸ¥æ‰¾èµ„æ–™æ—¶å¾ˆå®¹æ˜“æ··ï¼Œå‚»å‚»åˆ†ä¸æ¸…æ¥š ğŸ˜µâ€ğŸ’«

å¤„ç† Sass æ—¶éœ€è¦åšä»€ä¹ˆï¼Ÿ

# esbuild å¤„ç†é¡¹ç›®å†…éƒ¨ .css .scss .module.scss ç­‰èµ„æº
# esbuild å¤„ç† node_modules ä¸­çš„å¤–éƒ¨ .css .scss èµ„æº
# å…è®¸åœ¨ .tsx ä¸­ä½¿ç”¨å†…éƒ¨ .scss å’Œ node_modules ä¸­çš„å¤–éƒ¨ .scss

æ•ˆæœï¼š

[img[https://i.gyazo.com/5f8a235e32101ef23b62471705aa4894.png]]

[img[https://i.gyazo.com/9feb18a4e9a4a9f1ced25b67c6b9c7f8.png]]

!! 4. åè°ƒ rails å’Œ esbuild

è™½ç„¶æˆ‘ä»¬å®‰è£…äº† jsbundling-rails ï¼Œä½†æ˜¯ç”±äºé¡¹ç›®å¤æ‚ï¼Œæ¶‰åŠåˆ° ActiveAdmin å’Œ Standalone Sass ç­‰å› ç´ ï¼Œæˆ‘ä»¬éœ€è¦ä¿ç•™ Rails compile ä¸­å…³äº Asset Pipeline çš„ä¸€äº›é…ç½®ã€‚

ä¾‹å¦‚ï¼šå¼€å‘ç¯å¢ƒä¸‹ rails server ä¸åº”è¯¥äºŒæ¬¡ç¼–è¯‘ frontend assets

```ruby
# config/environments/development.rb
Rails.application.configure do

  # Suppress logger output for asset requests.
  config.assets.quiet = true

  # Do not compress assets
  config.assets.compress = false

  # Don't Digest assets, makes debugging uglier
  config.assets.digest = false
  ...
end
```

!! 5. é¡ºæ‰‹æ”¹å–„çš„å¼€å‘ä½“éªŒ

1. webpack æ—¶ä»£å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨äº† react production modeï¼Œå¯¼è‡´æ— æ³•é€šè¿‡ inspect ç›´æ¥å®šä½åˆ° React Components æºç 

2. ç»Ÿä¸€ .scss å’Œ .tsx ç›¸åŒçš„é»˜è®¤è·¯å¾„

æ•ˆæœå¦‚å›¾ï¼š

[img[https://i.gyazo.com/1c73011c52b5cbbae3927d86ce395c6c.png]]

3. è®°å½• esbuild auto-rebuild å’Œ production build è€—æ—¶

esbuild é»˜è®¤æ²¡æœ‰æä¾› build è€—æ—¶ï¼Œä¸ºäº†æ¯”è¾ƒ webpack -> esbuild æ•ˆæœï¼Œæˆ‘ç¼–å†™äº†ä¸‹é¢ esbuild plugin æ¥è®°å½• esbuild è€—æ—¶ã€‚

```js
const context = await esbuild.context({
  plugins: [{
      name: 'log-rebuild-time',
      setup(build) {
        let startTime
        build.onStart(() => {
          startTime = Date.now()
          consola.start(`[esbuild] Building...`)
        })
        build.onEnd(() => {
          const now = new Date()
          const duration = now - startTime
          consola.log(`Time: ${duration}ms`)
          consola.log(`Built at ${now.toLocaleString('en-US', { hour12: true })}`)
        })
      },
    },
```

ä½ å¯ä»¥ç›´æ¥ copy-paste åˆ°ä½ çš„ esbuild.config.js ä¸­ä½¿ç”¨ã€‚

!! å¥½ç‰©åˆ†äº«

1. Grep.app

åœ¨å®Œæˆ rails é¡¹ç›® webpack åˆ° esbuild çš„è¿ç§»è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç° Grep.app éå¸¸å¥½ç”¨ã€‚æˆ‘åœ¨ Grep.app ä¸ŠæŸ¥çœ‹è‡ªå·±é…ç½®æ˜¯å¦å’Œä¸»æµ rails é¡¹ç›®ä¸­çš„é…ç½®æ˜¯å¦ç›¸åŒï¼Œçœ‹åˆ°ä¸€äº› stars å¾ˆå¤šçš„å¼€æºé¡¹ç›®é‡‡ç”¨äº†æˆ‘ç¼–å†™çš„é…ç½®ï¼Œè®©æˆ‘æ›´æœ‰ä¿¡å¿ƒäº†ã€‚

!! ä»Šåçš„è¯¾é¢˜

# é¡¹ç›®æ²¡æœ‰ e2e testing å¯¼è‡´éœ€è¦äººå·¥ä¸€ä¸ªé¡µé¢ä¸€ä¸ªé¡µé¢ç¡®è®¤ï¼Œè´¹æ—¶åˆè´¹åŠ›ã€‚åº”è¯¥å°½å¿«å¼•å…¥ e2e testing, visual testing ç­‰è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ŒçœŸå·§ï¼Œè‡ªåŠ¨åŒ–æµ‹è¯•æˆ‘ä¹Ÿå¾ˆæ“…é•¿ï¼ŒğŸ˜„
# sass-rails å·²ç» 7å¹´æ²¡æœ‰æ›´æ–°è¿‡äº†ï¼Œrails ç¤¾åŒºä¹Ÿå·²ç»ä¸ç»´æŠ¤å®ƒäº†ï¼Œåº”è¯¥å°½å¿«ç§»é™¤ ğŸ«£
# é¡¹ç›®ä¸­ JavaScript export ä¸åˆç†ï¼Œå­˜åœ¨è¿‡åº¦æ‰“åŒ…ç°è±¡ï¼Œ.js æ–‡ä»¶è¿‡å¤§ï¼Œå­˜åœ¨æ€§èƒ½é—®é¢˜ ğŸ¢

--- ä»¥ä¸Šï¼Œæ„Ÿè°¢ä½ çš„é˜…è¯» ---

!! Refs

* https://github.com/rails/jsbundling-rails
* https://github.com/rails/cssbundling-rails
* https://github.com/rails/webpacker
* https://github.com/glromeo/esbuild-sass-plugin
* https://activeadmin.info/
* https://guides.rubyonrails.org/v7.2/asset_pipeline.html
* https://grep.app/